<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Bleed Edge Setter</title>
<meta name="theme-color" content="#0a0a14">
<style>
  :root {
    --gold:#dca03c; --gold-light:#f0c060; --gold-dark:#8a5a10;
    --deep:#0a0a14; --surface:#111118; --surface2:#191920;
    --border:#2a2820; --text:#f0ead8; --muted:#7a7060;
    --green:#27ae60; --green-dark:#1a4a2a;
  }
  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  body { background:var(--deep); color:var(--text); font-family:Georgia,serif; min-height:100vh; padding-bottom:40px; }
  .topbar { background:var(--surface); border-bottom:1px solid var(--border); padding:16px 20px 12px; display:flex; align-items:center; gap:12px; position:sticky; top:0; z-index:10; }
  .topbar-icon { width:36px; height:36px; background:linear-gradient(135deg,var(--gold-dark),var(--gold)); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:0.65rem; font-weight:bold; color:#0a0a14; flex-shrink:0; }
  .topbar h1 { font-size:1rem; color:var(--gold-light); letter-spacing:0.05em; }
  .topbar p { font-size:0.72rem; color:var(--muted); }
  .main { padding:20px; }
  .card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:20px; margin-bottom:16px; position:relative; }
  .card::before { content:''; position:absolute; top:0;left:0;right:0; height:2px; background:linear-gradient(90deg,transparent,var(--gold),transparent); border-radius:12px 12px 0 0; }
  .card-label { font-size:0.7rem; letter-spacing:0.15em; color:var(--gold); text-transform:uppercase; margin-bottom:14px; }
  .type-toggle { display:flex; gap:8px; margin-bottom:18px; }
  .type-btn { flex:1; padding:12px 8px; border-radius:10px; border:1px solid var(--border); background:var(--surface2); color:var(--muted); font-size:0.82rem; font-family:Georgia,serif; cursor:pointer; text-align:center; transition:all 0.2s; }
  .type-btn.active { background:linear-gradient(135deg,var(--gold-dark),var(--gold)); color:#0a0a14; border-color:var(--gold); font-weight:bold; }
  .type-btn .t-icon { font-size:1.2rem; display:block; margin-bottom:4px; }
  .type-btn .t-label { font-size:0.75rem; display:block; }
  .border-row { display:flex; align-items:center; gap:12px; margin-bottom:14px; }
  .border-row label { font-size:0.82rem; color:var(--muted); white-space:nowrap; }
  input[type=number] { background:var(--surface2); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:1rem; padding:10px 14px; outline:none; width:100px; text-align:center; }
  input[type=number]:focus { border-color:var(--gold-dark); }
  .px-label { font-size:0.82rem; color:var(--muted); }
  .slider-row { display:flex; align-items:center; gap:10px; }
  input[type=range] { flex:1; accent-color:var(--gold); }
  .drop-zone { border:2px dashed var(--border); border-radius:12px; padding:32px 20px; text-align:center; cursor:pointer; background:var(--surface2); }
  .drop-zone .dz-icon { font-size:2rem; color:var(--gold-light); font-weight:bold; margin-bottom:8px; }
  .drop-zone p { font-size:0.85rem; color:var(--muted); line-height:1.6; }
  .drop-zone strong { color:var(--gold-light); }
  #queue-list { margin-top:14px; }
  .q-item { background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:10px 14px; margin-bottom:8px; display:flex; align-items:center; gap:10px; }
  .q-thumb { width:44px; height:44px; border-radius:6px; object-fit:cover; flex-shrink:0; background:var(--border); }
  .q-info { flex:1; min-width:0; }
  .q-name { font-size:0.82rem; color:var(--text); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .q-size { font-size:0.7rem; color:var(--muted); }
  .q-status { font-size:0.75rem; font-weight:bold; flex-shrink:0; }
  .q-status.done { color:#6fcf97; } .q-status.fail { color:#eb5757; }
  .q-status.pending { color:var(--muted); } .q-status.processing { color:var(--gold-light); }
  .btn-primary { width:100%; background:linear-gradient(135deg,var(--gold-dark),var(--gold)); color:#0a0a14; font-weight:bold; font-size:0.9rem; letter-spacing:0.1em; border:none; border-radius:10px; padding:14px; cursor:pointer; margin-top:12px; }
  .btn-primary:disabled { opacity:0.4; }
  .btn-clear { width:100%; background:none; border:1px solid var(--border); color:var(--muted); font-size:0.82rem; border-radius:10px; padding:10px; cursor:pointer; margin-top:8px; }
  .btn-save { width:100%; background:linear-gradient(135deg,var(--green-dark),var(--green)); color:#fff; font-weight:bold; font-size:0.9rem; letter-spacing:0.1em; border:none; border-radius:10px; padding:14px; cursor:pointer; margin-top:12px; display:none; }
  .progress-track { background:var(--surface2); border:1px solid var(--border); border-radius:99px; height:8px; overflow:hidden; margin:12px 0; }
  .progress-fill { height:100%; background:linear-gradient(90deg,var(--gold-dark),var(--gold-light)); border-radius:99px; width:0%; transition:width 0.3s; }
  .progress-label { font-size:0.82rem; color:var(--gold-light); text-align:center; margin-bottom:8px; }
  .tips { background:rgba(220,160,60,0.04); border:1px solid rgba(220,160,60,0.12); border-radius:8px; padding:14px 16px; font-size:0.82rem; line-height:1.7; color:var(--muted); margin-top:10px; }
  .tips strong { color:var(--gold-light); display:block; margin-bottom:4px; font-size:0.75rem; letter-spacing:0.08em; text-transform:uppercase; }
  .tips code { background:var(--surface2); border:1px solid var(--border); border-radius:4px; padding:1px 5px; font-size:0.8rem; color:var(--gold-light); }
  canvas { display:none; }
  @keyframes spin { to { transform:rotate(360deg); } }
  .spinner { display:inline-block; width:12px; height:12px; border:2px solid rgba(220,160,60,0.3); border-top-color:var(--gold); border-radius:50%; animation:spin 0.8s linear infinite; vertical-align:middle; margin-right:6px; }
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-icon">BES</div>
  <div>
    <h1>Bleed Edge Setter</h1>
    <p>Add bleed borders to your images</p>
  </div>
</div>

<div class="main">
  <div class="card">
    <div class="card-label">Settings</div>
    <div class="type-toggle">
      <div class="type-btn active" id="btn-mirror" onclick="selectType('mirror')">
        <span class="t-icon">[ ]</span>
        <span class="t-label">Mirror</span>
      </div>
      <div class="type-btn" id="btn-black" onclick="selectType('black')">
        <span class="t-icon">[ ]</span>
        <span class="t-label">Black</span>
      </div>
    </div>
    <div class="border-row">
      <label>Border size</label>
      <input type="number" id="border-px" value="35" min="1" max="2000" oninput="syncSlider()">
      <span class="px-label">px</span>
    </div>
    <div class="slider-row">
      <span style="font-size:0.72rem;color:var(--muted)">1</span>
      <input type="range" id="border-slider" min="1" max="500" value="35" oninput="syncInput()">
      <span style="font-size:0.72rem;color:var(--muted)">500</span>
    </div>
  </div>

  <div class="card">
    <div class="card-label">Images</div>
    <div class="drop-zone" onclick="openPicker()">
      <div class="dz-icon">+</div>
      <p><strong>Tap to select images</strong><br>JPG, PNG, WEBP supported<br>Multiple selection allowed</p>
    </div>
    <div id="queue-list"></div>
    <button class="btn-primary" id="btn-process" onclick="processAll()" disabled>Process All</button>
    <button class="btn-clear" onclick="clearQueue()">Clear list</button>
  </div>

  <div class="card" id="progress-card" style="display:none">
    <div class="card-label">Progress</div>
    <div class="progress-label" id="progress-label"><span class="spinner"></span> Processing...</div>
    <div class="progress-track"><div class="progress-fill" id="progress-fill"></div></div>
    <button class="btn-save" id="btn-save-all" onclick="saveAll()">Save All to "Bleed Edge"</button>
  </div>

  <div class="card">
    <div class="card-label">How it works</div>
    <div class="tips">
      <strong>Mirror border</strong>
      Extends the image by reflecting edge pixels outward.
    </div>
    <div class="tips">
      <strong>Black border</strong>
      Adds a solid black border around the image.
    </div>
    <div class="tips">
      <strong>Output</strong>
      Saved as PNG in <code>Downloads / Bleed Edge</code>. Same filename as original.
    </div>
  </div>
</div>

<canvas id="work-canvas"></canvas>

<script>
let queue = [];
let results = [];
let borderType = 'mirror';

// ── Called by Java: receives file as base64 dataUrl + real filename ──────
function receiveImage(dataUrl, realName) {
  // If realName looks like a pure number (Android internal ID), ignore it
  // and try to extract something meaningful, or fall back to 'image.png'
  let useName = realName || 'image.png';
  if (/^\d+$/.test(useName.replace(/\.\w+$/, ''))) {
    // Pure numeric name - keep it as-is, it's likely already the real filename
    // e.g. "6ed-4-armageddon.png" would NOT match this, "1000095904" would
    useName = realName;
  }
  fetch(dataUrl)
    .then(r => r.blob())
    .then(blob => {
      const objectUrl = URL.createObjectURL(blob);
      queue.push({
        file: { size: blob.size, type: blob.type },
        name: useName,
        objectUrl: objectUrl,
        status: 'pending'
      });
      renderQueue();
      document.getElementById('btn-process').disabled = false;
    });
}

// ── Open file picker via Java bridge ────────────────────────────────────
function openPicker() {
  if (typeof AndroidBridge !== 'undefined') {
    AndroidBridge.openPicker();
  }
}

function selectType(type) {
  borderType = type;
  document.getElementById('btn-mirror').classList.toggle('active', type === 'mirror');
  document.getElementById('btn-black').classList.toggle('active', type === 'black');
}

function syncSlider() {
  document.getElementById('border-slider').value = Math.min(parseInt(document.getElementById('border-px').value)||1, 500);
}
function syncInput() {
  document.getElementById('border-px').value = document.getElementById('border-slider').value;
}

function renderQueue() {
  const list = document.getElementById('queue-list');
  list.innerHTML = '';
  queue.forEach(item => {
    const div = document.createElement('div'); div.className = 'q-item';
    const thumb = document.createElement('img'); thumb.className = 'q-thumb'; thumb.src = item.objectUrl;
    const info = document.createElement('div'); info.className = 'q-info';
    const name = document.createElement('div'); name.className = 'q-name'; name.textContent = item.name;
    const size = document.createElement('div'); size.className = 'q-size';
    size.textContent = ((item.file.size||0) / 1024).toFixed(0) + ' KB';
    info.appendChild(name); info.appendChild(size);
    const status = document.createElement('div'); status.className = 'q-status ' + item.status;
    status.textContent = item.status === 'pending' ? 'Waiting'
      : item.status === 'processing' ? 'Processing...'
      : item.status === 'done' ? 'Done' : 'Error';
    div.appendChild(thumb); div.appendChild(info); div.appendChild(status);
    list.appendChild(div);
  });
}

function clearQueue() {
  queue.forEach(i => URL.revokeObjectURL(i.objectUrl));
  queue = []; results = []; renderQueue();
  document.getElementById('btn-process').disabled = true;
  document.getElementById('progress-card').style.display = 'none';
}

function applyMirrorBorder(img, b) {
  const sw = img.naturalWidth, sh = img.naturalHeight;
  const canvas = document.getElementById('work-canvas');
  canvas.width = sw + b*2; canvas.height = sh + b*2;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(img, b, b);
  ctx.save(); ctx.translate(b,b); ctx.scale(1,-1); ctx.drawImage(img,0,0,sw,b,0,0,sw,b); ctx.restore();
  ctx.save(); ctx.translate(b,b+sh); ctx.scale(1,-1); ctx.drawImage(img,0,sh-b,sw,b,0,-b,sw,b); ctx.restore();
  ctx.save(); ctx.translate(b,b); ctx.scale(-1,1); ctx.drawImage(img,0,0,b,sh,0,0,b,sh); ctx.restore();
  ctx.save(); ctx.translate(b+sw,b); ctx.scale(-1,1); ctx.drawImage(img,sw-b,0,b,sh,-b,0,b,sh); ctx.restore();
  ctx.save(); ctx.translate(b,b); ctx.scale(-1,-1); ctx.drawImage(img,0,0,b,b,0,0,b,b); ctx.restore();
  ctx.save(); ctx.translate(b+sw,b); ctx.scale(1,-1); ctx.drawImage(img,sw-b,0,b,b,0,0,b,b); ctx.restore();
  ctx.save(); ctx.translate(b,b+sh); ctx.scale(-1,1); ctx.drawImage(img,0,sh-b,b,b,0,0,b,b); ctx.restore();
  ctx.save(); ctx.translate(b+sw,b+sh); ctx.scale(1,1); ctx.drawImage(img,sw-b,sh-b,b,b,0,0,b,b); ctx.restore();
  return new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
}

function applyBlackBorder(img, b) {
  const canvas = document.getElementById('work-canvas');
  canvas.width = img.naturalWidth + b*2; canvas.height = img.naturalHeight + b*2;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img, b, b);
  return new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
}

function loadImage(url) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = url;
  });
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

async function processAll() {
  const borderPx = parseInt(document.getElementById('border-px').value) || 35;
  results = [];
  document.getElementById('progress-card').style.display = 'block';
  document.getElementById('btn-save-all').style.display = 'none';
  document.getElementById('btn-process').disabled = true;

  for (let i = 0; i < queue.length; i++) {
    const item = queue[i];
    item.status = 'processing'; renderQueue();
    document.getElementById('progress-fill').style.width = Math.round(i/queue.length*100) + '%';
    document.getElementById('progress-label').innerHTML =
      '<span class="spinner"></span> Processing ' + (i+1) + ' / ' + queue.length + '...';
    try {
      const img = await loadImage(item.objectUrl);
      const safeBorder = borderType === 'mirror'
        ? Math.min(borderPx, Math.floor(img.naturalWidth/2)-1, Math.floor(img.naturalHeight/2)-1)
        : borderPx;
      const blob = borderType === 'mirror'
        ? await applyMirrorBorder(img, safeBorder)
        : await applyBlackBorder(img, safeBorder);
      // Keep original name, just ensure .png extension
      const baseName = item.name.replace(/\.[^.]+$/, '');
      const filename = baseName + '.png';
      item.status = 'done';
      results.push({ blob, filename });
    } catch(e) { item.status = 'fail'; }
    renderQueue();
    await sleep(30);
  }

  document.getElementById('progress-fill').style.width = '100%';
  const doneCount = queue.filter(i => i.status === 'done').length;
  document.getElementById('progress-label').textContent = 'Done! ' + doneCount + ' / ' + queue.length + ' processed';
  document.getElementById('btn-save-all').style.display = doneCount > 0 ? 'block' : 'none';
  document.getElementById('btn-process').disabled = false;
}

function saveAll() {
  if (!results.length) return;
  if (typeof AndroidBridge !== 'undefined') {
    results.forEach((item, i) => {
      const reader = new FileReader();
      reader.onload = () => {
        AndroidBridge.saveBase64Image(reader.result.split(',')[1], item.filename);
        if (i === results.length - 1)
          AndroidBridge.showToast(results.length + ' images saved to Downloads/Bleed Edge');
      };
      reader.readAsDataURL(item.blob);
    });
  }
}
</script>
</body>
</html>